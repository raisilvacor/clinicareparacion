{% extends "admin/base_admin.html" %}

{% block title %}Agregar Slide - Panel Admin{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-image"></i> Agregar Nuevo Slide</h1>
    <p>Configure un nuevo slide para la página inicial</p>
</div>

<div class="admin-form-card">
    <form method="POST" action="{{ url_for('add_slide') }}" class="admin-form">
        <div class="form-group">
            <label for="imagem">
                <i class="fas fa-image"></i>
                Ruta de la Imagen *
            </label>
            <input type="file" id="imagem_upload" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="display: none;">
            <label for="imagem_upload" class="btn btn-primary" style="cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 10px;">
                <i class="fas fa-upload"></i> Elegir Imagen del Computador
            </label>
            <input type="text" id="imagem" name="imagem" required placeholder="La ruta de la imagen se completará automáticamente después de la carga" readonly>
            <small class="form-help">La ruta de la imagen se completará automáticamente después de la carga.</small>
            <div id="upload_status" style="margin-top: 5px;"></div>
        </div>
        
        <div class="form-group">
            <label for="preview">
                <i class="fas fa-eye"></i>
                Vista Previa de la Imagen
            </label>
            <div id="image-preview" style="width: 100%; max-width: 600px; height: 300px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; margin-top: 0.5rem;">
                <p style="color: #999;">La vista previa aparecerá aquí</p>
            </div>
        </div>
        
        <div class="form-group">
            <label for="link">
                <i class="fas fa-link"></i>
                Enlace del Slide (opcional)
            </label>
            <input type="url" id="link" name="link" placeholder="https://ejemplo.com o /pagina">
            <small class="form-help">URL a la que el slide debe redirigir al ser clicado. Deje en blanco si no desea enlace.</small>
        </div>
        
        <div class="form-group">
            <label for="link_target">
                <i class="fas fa-external-link-alt"></i>
                Abrir Link
            </label>
            <select id="link_target" name="link_target">
                <option value="_self">En la misma pestaña</option>
                <option value="_blank">En nueva pestaña</option>
            </select>
            <small class="form-help">Elija cómo se abrirá el enlace cuando se haga clic en el slide</small>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="ativo" name="ativo" checked>
                <span style="margin-left: 0.5rem;">Slide Activo</span>
            </label>
            <small class="form-help">Slides inactivos no serán mostrados en la página inicial</small>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('admin_slides') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Slide
            </button>
        </div>
    </form>
</div>

<script>
const inputFile = document.getElementById('imagem_upload');
const inputImagem = document.getElementById('imagem');
const preview = document.getElementById('image-preview');
const uploadStatus = document.getElementById('upload_status');

inputFile.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        uploadStatus.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> Tipo de archivo no permitido. Use: PNG, JPG, JPEG, GIF o WEBP</span>';
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        uploadStatus.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> Archivo muy grande. Tamaño máximo: 5MB</span>';
        return;
    }
    
    uploadStatus.innerHTML = '<span style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Enviando imagen...</span>';
    
    const formData = new FormData();
    formData.append('imagem', file);
    
    fetch('{{ url_for("upload_imagem_slide") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            inputImagem.value = data.path;
            uploadStatus.innerHTML = '<span style="color: green;"><i class="fas fa-check-circle"></i> ¡Imagen enviada con éxito!</span>';
            
            // Actualizar vista previa
            const img = document.createElement('img');
            // Usar la ruta directamente si comienza con /, sino agregar /static/
            if (data.path.startsWith('/')) {
                img.src = data.path;
            } else {
                img.src = '/static/' + data.path;
            }
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            img.style.objectFit = 'contain';
            preview.innerHTML = '';
            preview.appendChild(img);
        } else {
            uploadStatus.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> ' + (data.error || 'Error al enviar imagen') + '</span>';
        }
    })
    .catch(error => {
        uploadStatus.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> Error al enviar imagen: ' + error.message + '</span>';
    });
});

// Vista previa cuando el campo de texto es alterado manualmente
inputImagem.addEventListener('input', function(e) {
    const caminho = e.target.value.trim();
    if (caminho) {
        const img = document.createElement('img');
        // Usar la ruta directamente si comienza con /, sino agregar /static/
        if (caminho.startsWith('/')) {
            img.src = caminho;
        } else {
            img.src = '/static/' + caminho;
        }
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.objectFit = 'contain';
        img.onerror = function() {
            preview.innerHTML = '<p style="color: #dc3545;">Imagen no encontrada</p>';
        };
        img.onload = function() {
            preview.innerHTML = '';
            preview.appendChild(img);
        };
    } else {
        preview.innerHTML = '<p style="color: #999;">La vista previa aparecerá aquí</p>';
    }
});
</script>
{% endblock %}

