{% extends "admin/base_admin.html" %}

{% block title %}Emitir Orden de Servicio - Panel Admin{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-file-invoice"></i> Emitir Orden de Servicio</h1>
    <p>Complete todos los datos de la orden de servicio</p>
</div>

<div class="admin-form-card">
    <form method="POST" action="{{ url_for('add_ordem_servico') }}" class="admin-form">
        <div class="form-group">
            <label for="cliente_id">
                <i class="fas fa-user"></i>
                Cliente *
            </label>
            <select id="cliente_id" name="cliente_id" required>
                <option value="">Seleccione un cliente</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nome }} - {{ cliente.email }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="servico">
                <i class="fas fa-tools"></i>
                Tipo de Servicio *
            </label>
            <select id="servico" name="servico" required>
                <option value="">Seleccione un servicio</option>
                {% for tipo in tipos_servico %}
                <option value="{{ tipo }}">{{ tipo }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="tecnico_id">
                <i class="fas fa-user-cog"></i>
                Técnico Responsable
            </label>
            <select id="tecnico_id" name="tecnico_id">
                <option value="">Seleccione un técnico (opcional)</option>
                {% for tecnico in tecnicos %}
                <option value="{{ tecnico.id }}">{{ tecnico.nome }} - {{ tecnico.especialidade }}</option>
                {% endfor %}
            </select>
            <small class="form-help">Seleccione el técnico que será responsable de esta orden de servicio</small>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-box"></i> Características del Aparato</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="tipo_aparelho">
                    <i class="fas fa-mobile-alt"></i>
                    Tipo de Aparato *
                </label>
                <select id="tipo_aparelho" name="tipo_aparelho" required>
                    <option value="">Seleccione el tipo</option>
                    <option value="Celular">Celular</option>
                    <option value="Notebook">Notebook</option>
                    <option value="Computadora">Computadora</option>
                    <option value="Heladera">Heladera</option>
                    <option value="Lavadora">Lavadora</option>
                    <option value="Microondas">Microondas</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Aire Acondicionado">Aire Acondicionado</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="marca">
                    <i class="fas fa-tag"></i>
                    Marca *
                </label>
                <input type="text" id="marca" name="marca" required placeholder="Ej: Samsung, LG, Brastemp">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="modelo">
                    <i class="fas fa-cube"></i>
                    Modelo *
                </label>
                <input type="text" id="modelo" name="modelo" required placeholder="Ej: Galaxy S21, ABC123">
            </div>
            
            <div class="form-group">
                <label for="numero_serie">
                    <i class="fas fa-barcode"></i>
                    Número de Serie
                </label>
                <input type="text" id="numero_serie" name="numero_serie" placeholder="Número de serie del aparato">
            </div>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-exclamation-triangle"></i> Defectos y Diagnóstico</h3>
        </div>
        
        <div class="form-group">
            <label for="defeitos_cliente">
                <i class="fas fa-comment-dots"></i>
                Defectos Reportados por el Cliente *
            </label>
            <textarea id="defeitos_cliente" name="defeitos_cliente" rows="4" required placeholder="Describa los defectos reportados por el cliente..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="diagnostico_tecnico">
                <i class="fas fa-stethoscope"></i>
                Diagnóstico Técnico *
            </label>
            <textarea id="diagnostico_tecnico" name="diagnostico_tecnico" rows="4" required placeholder="Describa el diagnóstico técnico realizado..."></textarea>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-dollar-sign"></i> Costos</h3>
        </div>
        
        <div class="form-group">
            <label>
                <i class="fas fa-cog"></i>
                Repuestos a Ser Cambiados
            </label>
            <div class="pecas-list" id="pecas-list">
                {% for i in range(10) %}
                <div class="peca-item">
                    <input type="text" name="peca_nome_{{ i }}" class="peca-nome" placeholder="Nombre del repuesto (ej: Pantalla, Batería, Conector)" data-index="{{ i }}">
                    <input type="number" name="peca_custo_{{ i }}" class="peca-custo" step="0.01" min="0" value="0.00" placeholder="0.00" data-index="{{ i }}">
                    <span class="peca-currency">ARS$</span>
                </div>
                {% endfor %}
            </div>
            <div class="pecas-total">
                <strong>Total de Repuestos: <span id="total_pecas">ARS$ 0.00</span></strong>
            </div>
        </div>
        
        <div class="form-group">
            <label for="custo_mao_obra">
                <i class="fas fa-wrench"></i>
                Costo de Mano de Obra (ARS$)
            </label>
            <input type="number" id="custo_mao_obra" name="custo_mao_obra" step="0.01" min="0" value="0.00" placeholder="0.00">
        </div>
        
        <div class="cost-summary">
            <div class="summary-item">
                <span>Repuestos:</span>
                <span id="display_pecas">ARS$ 0.00</span>
            </div>
            <div class="summary-item">
                <span>Mano de Obra:</span>
                <span id="display_mao_obra">ARS$ 0.00</span>
            </div>
            <div class="summary-item total">
                <span><strong>Total:</strong></span>
                <span id="display_total"><strong>ARS$ 0.00</strong></span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="cupom_id">
                <i class="fas fa-gift"></i>
                Cupón de Descuento (Club Clínica de Reparación)
            </label>
            <select id="cupom_id" name="cupom_id">
                <option value="">Ningún cupón</option>
            </select>
            <small class="form-help">Seleccione un cliente primero para ver cupones disponibles</small>
        </div>
        
        <div class="form-group" id="desconto_info" style="display: none;">
            <label>
                <i class="fas fa-percent"></i>
                Descuento Aplicado
            </label>
            <div class="desconto-display">
                <p><strong>Descuento:</strong> <span id="desconto_percent">0%</span></p>
                <p><strong>Valor del Descuento:</strong> <span id="valor_desconto">ARS$ 0.00</span></p>
                <p><strong>Subtotal:</strong> <span id="subtotal_display">ARS$ 0.00</span></p>
                <p class="total-final"><strong>Total con Descuento:</strong> <span id="total_com_desconto">ARS$ 0.00</span></p>
            </div>
        </div>
        
        <div class="form-group">
            <label for="status">
                <i class="fas fa-info-circle"></i>
                Estado de la Orden
            </label>
            <select id="status" name="status">
                <option value="pendente">Pendiente</option>
                <option value="em_andamento">En Proceso</option>
                <option value="concluido">Concluido</option>
                <option value="pago">Pagado</option>
                <option value="cancelado">Cancelado</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="prazo_estimado">
                <i class="fas fa-calendar-alt"></i>
                Plazo Estimado
            </label>
            <input type="text" id="prazo_estimado" name="prazo_estimado" placeholder="Ej: 5 días hábiles, 1 semana, 15 días">
            <small class="form-help">Informe el plazo estimado para conclusión del servicio</small>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('admin_ordens') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Emitir Orden de Servicio
            </button>
        </div>
    </form>
</div>

<script>
// Calcular total de repuestos
function calcularTotalPecas() {
    const pecasInputs = document.querySelectorAll('.peca-custo');
    let totalPecas = 0;
    
    pecasInputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        totalPecas += valor;
    });
    
    document.getElementById('total_pecas').textContent = 'ARS$ ' + totalPecas.toFixed(2);
    document.getElementById('display_pecas').textContent = 'ARS$ ' + totalPecas.toFixed(2);
    
    calcularTotal();
}

// Calcular total general
function calcularTotal() {
    const pecasInputs = document.querySelectorAll('.peca-custo');
    let totalPecas = 0;
    
    pecasInputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        totalPecas += valor;
    });
    
    const custoMaoObra = parseFloat(document.getElementById('custo_mao_obra').value) || 0;
    const subtotal = totalPecas + custoMaoObra;
    
    // Aplicar descuento si hay cupón seleccionado
    const cupomSelect = document.getElementById('cupom_id');
    const cupomSelecionado = cupomSelect.options[cupomSelect.selectedIndex];
    let total = subtotal;
    let descontoPercent = 0;
    let valorDesconto = 0;
    
    if (cupomSelecionado && cupomSelecionado.value && cupomSelecionado.dataset.desconto) {
        descontoPercent = parseFloat(cupomSelecionado.dataset.desconto);
        valorDesconto = subtotal * (descontoPercent / 100);
        total = subtotal - valorDesconto;
        
        // Mostrar información de descuento
        document.getElementById('desconto_info').style.display = 'block';
        document.getElementById('desconto_percent').textContent = descontoPercent.toFixed(2) + '%';
        document.getElementById('valor_desconto').textContent = 'ARS$ ' + valorDesconto.toFixed(2);
        document.getElementById('subtotal_display').textContent = 'ARS$ ' + subtotal.toFixed(2);
        document.getElementById('total_com_desconto').textContent = 'ARS$ ' + total.toFixed(2);
    } else {
        document.getElementById('desconto_info').style.display = 'none';
    }
    
    document.getElementById('display_mao_obra').textContent = 'ARS$ ' + custoMaoObra.toFixed(2);
    document.getElementById('display_total').innerHTML = '<strong>ARS$ ' + total.toFixed(2) + '</strong>';
}

// Carregar cupons quando cliente é selecionado
document.getElementById('cliente_id').addEventListener('change', function() {
    const clienteId = this.value;
    const cupomSelect = document.getElementById('cupom_id');
    const descontoInfo = document.getElementById('desconto_info');
    
    if (!clienteId) {
        cupomSelect.innerHTML = '<option value="">Nenhum cupom</option>';
        cupomSelect.disabled = true;
        descontoInfo.style.display = 'none';
        calcularTotal();
        return;
    }
    
    // Buscar cupons do cliente
    fetch(`/admin/fidelidade/${clienteId}/cupons`)
        .then(response => response.json())
        .then(data => {
            cupomSelect.innerHTML = '<option value="">Ningún cupón</option>';
            
            if (data.cupons && data.cupons.length > 0) {
                data.cupons.forEach(cupom => {
                    const option = document.createElement('option');
                    option.value = cupom.id;
                    option.textContent = `${cupom.desconto_percentual}% de descuento`;
                    option.dataset.desconto = cupom.desconto_percentual;
                    cupomSelect.appendChild(option);
                });
                cupomSelect.disabled = false;
            } else {
                cupomSelect.innerHTML = '<option value="">Ningún cupón disponible</option>';
                cupomSelect.disabled = true;
            }
            calcularTotal();
        })
        .catch(error => {
            console.error('Error al buscar cupones:', error);
            cupomSelect.innerHTML = '<option value="">Error al cargar cupones</option>';
        });
});

// Recalcular cuando cupón es seleccionado
document.getElementById('cupom_id').addEventListener('change', calcularTotal);

// Agregar event listeners para todos los campos de costo de repuestos
document.querySelectorAll('.peca-custo').forEach(input => {
    input.addEventListener('input', calcularTotalPecas);
});

// Agregar event listener para mano de obra
document.getElementById('custo_mao_obra').addEventListener('input', calcularTotal);

// Inicializar valores
calcularTotalPecas();
calcularTotal();
</script>
{% endblock %}
