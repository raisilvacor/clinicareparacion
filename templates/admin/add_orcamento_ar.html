{% extends "admin/base_admin.html" %}

{% block title %}Nuevo Presupuesto de Aire Acondicionado - Panel Admin{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-snowflake"></i> Nuevo Presupuesto de Aire Acondicionado</h1>
    <p>Complete los datos para generar el presupuesto</p>
</div>

<div class="admin-form-card">
    <form method="POST" action="{{ url_for('add_orcamento_ar') }}" class="admin-form" id="orcamentoForm">
        <div class="form-row">
            <div class="form-group">
                <label for="cliente_id">
                    <i class="fas fa-user"></i>
                    Cliente *
                </label>
                <select id="cliente_id" name="cliente_id" required>
                    <option value="">Seleccione un cliente</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nome }} - {{ cliente.email }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="tecnico_id">
                    <i class="fas fa-user-cog"></i>
                    Técnico
                </label>
                <select id="tecnico_id" name="tecnico_id">
                    <option value="">Seleccione un técnico (opcional)</option>
                    {% for tecnico in tecnicos %}
                    <option value="{{ tecnico.id }}">{{ tecnico.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-tools"></i> Datos del Servicio</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="tipo_servico">
                    <i class="fas fa-wrench"></i>
                    Tipo de Servicio *
                </label>
                <select id="tipo_servico" name="tipo_servico" required onchange="calcularPreco()">
                    <option value="">Seleccione el tipo de servicio</option>
                    <option value="Instalação de Ar-Condicionado Split">Instalación de Aire Acondicionado Split</option>
                    <option value="Limpeza preventiva da Evaporadora">Limpieza preventiva de la Evaporadora</option>
                    <option value="Limpeza preventiva Evaporadora + Condensadora">Limpieza preventiva Evaporadora + Condensadora</option>
                    <option value="Remoção de Ar-Condicionado Split">Remoción de Aire Acondicionado Split</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="potencia_btu">
                    <i class="fas fa-bolt"></i>
                    Potencia (BTU) *
                </label>
                <select id="potencia_btu" name="potencia_btu" required onchange="calcularPreco()">
                    <option value="">Seleccione la potencia</option>
                    <option value="9000">9000 BTU</option>
                    <option value="12000">12000 BTU</option>
                    <option value="18000">18000 BTU</option>
                    <option value="24000">24000 BTU</option>
                    <option value="36000">36000 BTU</option>
                    <option value="48000">48000 BTU</option>
                    <option value="60000">60000 BTU</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="tipo_acesso">
                <i class="fas fa-ladder"></i>
                Tipo de Acceso *
            </label>
            <select id="tipo_acesso" name="tipo_acesso" required onchange="calcularPreco()">
                <option value="">Seleccione el tipo de acceso</option>
                <option value="Fácil">Acceso Fácil - Acceso directo sin obstáculos, hasta 3 metros de altura, posición cómoda de trabajo.</option>
                <option value="Moderado">Acceso Moderado - Lugares con interferencia de mobiliario, altura entre 3 y 4 metros, posición de trabajo incómoda.</option>
                <option value="Difícil">Acceso Difícil - Altura superior a 4 metros, posición inadecuada de trabajo, horario fuera del comercial.</option>
            </select>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-box"></i> Información del Aparato</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="marca_aparelho">
                    <i class="fas fa-tag"></i>
                    Marca do Aparelho
                </label>
                <input type="text" id="marca_aparelho" name="marca_aparelho" placeholder="Ej: Samsung, LG, Consul">
            </div>
            
            <div class="form-group">
                <label for="modelo_aparelho">
                    <i class="fas fa-cube"></i>
                    Modelo do Aparelho
                </label>
                <input type="text" id="modelo_aparelho" name="modelo_aparelho" placeholder="Ej: Split 9000 BTU">
            </div>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-shopping-cart"></i> Materiales Adicionales</h3>
        </div>
        
        <div class="form-group">
            <label for="material_adicional">
                <i class="fas fa-tools"></i>
                Material Adicional
            </label>
            <select id="material_adicional" name="material_adicional" onchange="toggleMaterialAdicional()">
                <option value="">Ningún material adicional</option>
                <option value="Kit Convencional (3m de tubulação)">Kit Convencional (3m de tubulación) + ARS$ 250,00</option>
                <option value="Tubulação extra acima de 3m">Tubería extra por encima de 3m</option>
            </select>
        </div>
        
        <div class="form-group" id="campo_valor_material" style="display: none;">
            <label for="valor_material_adicional">
                <i class="fas fa-dollar-sign"></i>
                Valor de la Tubulación Extra (ARS$)
            </label>
            <input type="number" id="valor_material_adicional" name="valor_material_adicional" step="0.01" min="0" placeholder="0.00" onchange="calcularPreco()">
            <small class="form-help">Ingrese el valor manualmente para tubería extra por encima de 3m</small>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-list"></i> Costos Adicionales (Opcional)</h3>
        </div>
        
        <div id="custos_adicionais_container">
            <div class="custo-adicional-item" data-index="0">
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group" style="flex: 1;">
                        <label>
                            <i class="fas fa-tag"></i>
                            Item
                        </label>
                        <input type="text" name="custo_adicional_item[]" class="custo-item-input" placeholder="Nombre del elemento" onchange="calcularPreco()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>
                            <i class="fas fa-dollar-sign"></i>
                            Valor (ARS$)
                        </label>
                        <input type="number" name="custo_adicional_valor[]" class="custo-valor-input" step="0.01" min="0" placeholder="0.00" onchange="calcularPreco()">
                    </div>
                    <div class="form-group" style="width: auto; margin-left: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="adicionarCustoAdicional()" title="Agregar item">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-calculator"></i> Resumen del Presupuesto</h3>
        </div>
        
        <div id="resumo_orcamento" style="background: #f5f5f5; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 8px; font-weight: bold;">Valor Base:</td>
                    <td style="padding: 8px; text-align: right;" id="valor_base_display">ARS$ 0,00</td>
                </tr>
                <tr>
                    <td style="padding: 8px; font-weight: bold;">Incremento por Acceso:</td>
                    <td style="padding: 8px; text-align: right;" id="valor_acesso_display">ARS$ 0,00</td>
                </tr>
                <tr>
                    <td style="padding: 8px; font-weight: bold;">Material Adicional:</td>
                    <td style="padding: 8px; text-align: right;" id="valor_material_display">ARS$ 0,00</td>
                </tr>
                <tbody id="custos_adicionais_display"></tbody>
                <tr>
                    <td style="padding: 8px; font-weight: bold;">Subtotal Costos Adicionales:</td>
                    <td style="padding: 8px; text-align: right;" id="valor_custos_adicionais_display">ARS$ 0,00</td>
                </tr>
                <tr style="border-top: 2px solid #215f97; font-size: 1.2em;">
                    <td style="padding: 12px 8px; font-weight: bold; color: #215f97;">TOTAL:</td>
                    <td style="padding: 12px 8px; text-align: right; font-weight: bold; color: #215f97;" id="valor_total_display">ARS$ 0,00</td>
                </tr>
            </table>
        </div>
        
        <div class="section-divider">
            <h3><i class="fas fa-info-circle"></i> Información Adicional</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="status">
                    <i class="fas fa-check-circle"></i>
                    Estado del Presupuesto *
                </label>
                <select id="status" name="status" required>
                    <option value="pendente">Pendiente</option>
                    <option value="aprovado">Aprobado</option>
                    <option value="recusado">Rechazado</option>
                    <option value="concluido">Concluido</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="prazo_estimado">
                    <i class="fas fa-calendar"></i>
                    Prazo Estimado
                </label>
                <input type="text" id="prazo_estimado" name="prazo_estimado" placeholder="Ej: 5 días, 1 semana">
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('admin_orcamentos_ar') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Presupuesto
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let custosAdicionaisIndex = 0;

function adicionarCustoAdicional() {
    custosAdicionaisIndex++;
    const container = document.getElementById('custos_adicionais_container');
    const novoItem = document.createElement('div');
    novoItem.className = 'custo-adicional-item';
    novoItem.setAttribute('data-index', custosAdicionaisIndex);
    
    novoItem.innerHTML = `
        <div class="form-row" style="align-items: flex-end; margin-top: 1rem;">
            <div class="form-group" style="flex: 1;">
                <label>
                    <i class="fas fa-tag"></i>
                    Item
                </label>
                <input type="text" name="custo_adicional_item[]" class="custo-item-input" placeholder="Nome do item" onchange="calcularPreco()">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>
                    <i class="fas fa-dollar-sign"></i>
                    Valor (ARS$)
                </label>
                <input type="number" name="custo_adicional_valor[]" class="custo-valor-input" step="0.01" min="0" placeholder="0.00" onchange="calcularPreco()">
            </div>
            <div class="form-group" style="width: auto; margin-left: 1rem;">
                            <button type="button" class="btn btn-secondary" onclick="adicionarCustoAdicional()" title="Agregar elemento">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="form-group" style="width: auto; margin-left: 0.5rem;">
                            <button type="button" class="btn btn-danger" onclick="removerCustoAdicional(this)" title="Remover elemento">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(novoItem);
}

function removerCustoAdicional(button) {
    const item = button.closest('.custo-adicional-item');
    item.remove();
    calcularPreco();
}

function calcularPreco() {
    const tipoServico = document.getElementById('tipo_servico').value;
    const potenciaBtu = parseInt(document.getElementById('potencia_btu').value) || 0;
    const tipoAcesso = document.getElementById('tipo_acesso').value;
    const materialAdicional = document.getElementById('material_adicional').value;
    const valorMaterialAdicional = parseFloat(document.getElementById('valor_material_adicional').value) || 0;
    
    // Calcular costos adicionales
    const custosAdicionais = [];
    const itemsInputs = document.querySelectorAll('.custo-item-input');
    const valoresInputs = document.querySelectorAll('.custo-valor-input');
    
    let valorCustosAdicionais = 0.00;
    for (let i = 0; i < itemsInputs.length; i++) {
        const item = itemsInputs[i].value.trim();
        const valor = parseFloat(valoresInputs[i].value) || 0;
        if (item && valor > 0) {
            custosAdicionais.push({item: item, valor: valor});
            valorCustosAdicionais += valor;
        }
    }
    
    if (!tipoServico || !potenciaBtu || !tipoAcesso) {
        atualizarResumo(0, 0, 0, 0, custosAdicionais);
        return;
    }
    
    // Tabla de precios base
    const precosBase = {
        'Instalação de Ar-Condicionado Split': {
            9000: 650.00,
            12000: 700.00,
            18000: 750.00,
            24000: 800.00,
            36000: 900.00,
            48000: 1200.00,
            60000: 1800.00
        },
        'Limpeza preventiva da Evaporadora': {
            'ate_18000': 150.00,
            '24000_36000': 200.00,
            'acima_36000': 250.00
        },
        'Limpeza preventiva Evaporadora + Condensadora': {
            'ate_18000': 250.00,
            '24000_36000': 300.00,
            'acima_36000': 350.00
        },
        'Remoção de Ar-Condicionado Split': {
            'ate_18000': 250.00,
            '24000_36000': 300.00,
            'acima_36000': 400.00
        }
    };
    
    // Calcular valor base
    let valorBase = 0.00;
    
    if (tipoServico === 'Instalação de Ar-Condicionado Split') {
        valorBase = precosBase[tipoServico][potenciaBtu] || 0.00;
    } else {
        if (potenciaBtu <= 18000) {
            valorBase = precosBase[tipoServico]['ate_18000'];
        } else if (potenciaBtu <= 36000) {
            valorBase = precosBase[tipoServico]['24000_36000'];
        } else {
            valorBase = precosBase[tipoServico]['acima_36000'];
        }
    }
    
    // Calcular incremento por acceso
    let valorAcesso = 0.00;
    if (tipoServico === 'Instalação de Ar-Condicionado Split') {
        if (tipoAcesso === 'Moderado') {
            valorAcesso = valorBase * 0.10; // 10%
        } else if (tipoAcesso === 'Difícil') {
            valorAcesso = valorBase * 0.20; // 20%
        }
    } else {
        if (tipoAcesso === 'Moderado') {
            valorAcesso = valorBase * 0.20; // 20%
        } else if (tipoAcesso === 'Difícil') {
            valorAcesso = valorBase * 0.30; // 30%
        }
    }
    
    // Valor do material adicional
    let valorMaterial = 0.00;
    if (materialAdicional === 'Kit Convencional (3m de tubulação)') {
        valorMaterial = 250.00;
    } else if (materialAdicional === 'Tubulação extra acima de 3m') {
        valorMaterial = valorMaterialAdicional;
    }
    
    // Calcular total
    const valorTotal = valorBase + valorAcesso + valorMaterial + valorCustosAdicionais;
    
    atualizarResumo(valorBase, valorAcesso, valorMaterial, valorTotal, custosAdicionais);
}

function toggleMaterialAdicional() {
    const materialAdicional = document.getElementById('material_adicional').value;
    const campoValorMaterial = document.getElementById('campo_valor_material');
    
    if (materialAdicional === 'Tubulação extra acima de 3m') {
        campoValorMaterial.style.display = 'block';
        document.getElementById('valor_material_adicional').value = '';
    } else {
        campoValorMaterial.style.display = 'none';
        document.getElementById('valor_material_adicional').value = '0';
    }
    
    calcularPreco();
}

function atualizarResumo(valorBase, valorAcesso, valorMaterial, valorTotal, custosAdicionais = []) {
    document.getElementById('valor_base_display').textContent = formatarMoeda(valorBase);
    document.getElementById('valor_acesso_display').textContent = formatarMoeda(valorAcesso);
    document.getElementById('valor_material_display').textContent = formatarMoeda(valorMaterial);
    
    // Actualizar costos adicionales
    const custosDisplay = document.getElementById('custos_adicionais_display');
    custosDisplay.innerHTML = '';
    
    let valorTotalCustos = 0.00;
    custosAdicionais.forEach(function(custo) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding: 8px;">${custo.item}:</td>
            <td style="padding: 8px; text-align: right;">${formatarMoeda(custo.valor)}</td>
        `;
        custosDisplay.appendChild(tr);
        valorTotalCustos += custo.valor;
    });
    
    document.getElementById('valor_custos_adicionais_display').textContent = formatarMoeda(valorTotalCustos);
    document.getElementById('valor_total_display').textContent = formatarMoeda(valorTotal);
}

function formatarMoeda(valor) {
    return 'ARS$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Calcular al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    calcularPreco();
});
</script>
{% endblock %}

